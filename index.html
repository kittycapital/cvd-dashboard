<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>거래소별 CVD Dashboard | Herdvibe</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.1/kakao.min.js" crossorigin="anonymous" async></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@700;900&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg-primary: #0a0a0f; --bg-secondary: #12121a; --bg-card: #16161f;
    --bg-hover: #1e1e2a; --border: #252535; --text-primary: #e8e8ef;
    --text-secondary: #8888a0; --text-muted: #55556a;
    --accent-green: #00e676; --accent-red: #ff1744;
    --accent-blue: #448aff; --accent-purple: #b388ff; --accent-orange: #ff9100;
  }
  body { background: var(--bg-primary); color: var(--text-primary); font-family: 'JetBrains Mono', monospace; min-height: 100vh; overflow-x: hidden; }
  .header { display: flex; flex-direction: column; align-items: center; padding: 20px 24px 16px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); gap: 12px; }
  .header-title { font-family: 'Noto Sans KR', sans-serif; font-size: 22px; font-weight: 900; letter-spacing: 2px; color: var(--text-primary); }
  .coin-tabs { display: flex; gap: 4px; background: var(--bg-primary); padding: 3px; border-radius: 8px; }
  .coin-tab { padding: 8px 20px; border: none; background: transparent; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 500; cursor: pointer; border-radius: 6px; transition: all 0.2s; letter-spacing: 1px; }
  .coin-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
  .coin-tab.active { background: var(--accent-green); color: #000; font-weight: 700; }
  .status-bar { display: flex; align-items: center; gap: 12px; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-red); transition: background 0.3s; }
  .status-dot.connected { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
  .status-text { font-size: 11px; color: var(--text-muted); }
  .dashboard { padding: 16px 24px; display: flex; flex-direction: column; gap: 12px; }
  .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; position: relative; overflow: hidden; }
  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .section-title { font-size: 11px; color: var(--text-muted); letter-spacing: 2px; text-transform: uppercase; }
  .price-display { display: flex; align-items: baseline; gap: 12px; }
  .current-price { font-size: 28px; font-weight: 700; color: var(--text-primary); }
  .price-change { font-size: 13px; font-weight: 500; }
  .price-change.up { color: var(--accent-green); }
  .price-change.down { color: var(--accent-red); }
  .chart-container { position: relative; height: 200px; }
  .cvd-chart-container { position: relative; height: 280px; }
  .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'JetBrains Mono', monospace; font-size: 40px; font-weight: 700; color: rgba(255,255,255,0.03); pointer-events: none; letter-spacing: 4px; white-space: nowrap; z-index: 1; }
  .exchange-legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
  .legend-item { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--bg-primary); border-radius: 6px; font-size: 11px; border: 1px solid var(--border); transition: opacity 0.2s; cursor: pointer; }
  .legend-item:hover { border-color: var(--text-muted); }
  .legend-item.hidden { opacity: 0.3; }
  .legend-dot { width: 10px; height: 10px; border-radius: 3px; }
  .legend-name { color: var(--text-secondary); }
  .legend-value { font-weight: 600; min-width: 80px; text-align: right; }
  .legend-value.positive { color: var(--accent-green); }
  .legend-value.negative { color: var(--accent-red); }
  .info-row { display: flex; gap: 24px; flex-wrap: wrap; }
  .info-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; flex: 1; min-width: 180px; }
  .info-label { font-size: 10px; color: var(--text-muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
  .info-value { font-size: 18px; font-weight: 600; }
  .info-value.positive { color: var(--accent-green); }
  .info-value.negative { color: var(--accent-red); }
  .controls-row { display: flex; align-items: center; gap: 8px; }
  .timeframe-btn { padding: 5px 12px; border: 1px solid var(--border); background: transparent; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; font-size: 11px; cursor: pointer; border-radius: 4px; transition: all 0.2s; }
  .timeframe-btn:hover { border-color: var(--text-muted); color: var(--text-primary); }
  .timeframe-btn.active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); }
  .reset-btn { padding: 5px 12px; border: 1px solid var(--accent-red); background: transparent; color: var(--accent-red); font-family: 'JetBrains Mono', monospace; font-size: 11px; cursor: pointer; border-radius: 4px; margin-left: auto; transition: all 0.2s; }
  .reset-btn:hover { background: var(--accent-red); color: #000; }
  .share-bar { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; border-top: 1px solid var(--border); background: var(--bg-secondary); border-radius: 0 0 12px 12px; }
  .share-bar-preview { font-size: .75rem; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 50%; line-height: 1.4; }
  .share-bar-preview span { color: var(--text-secondary); font-weight: 500; }
  .share-bar-buttons { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
  .share-btn { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 6px; font-size: .75rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 150ms ease; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-muted); white-space: nowrap; }
  .share-btn:hover { transform: translateY(-1px); color: var(--text-primary); }
  .share-btn svg { flex-shrink: 0; }
  .share-btn--x:hover { border-color: #fff; color: #fff; background: #111; }
  .share-btn--kakao:hover { border-color: #FEE500; color: #191919; background: #FEE500; }
  .share-btn--tg:hover { border-color: #26A5E4; color: #fff; background: rgba(38,165,228,.15); }
  .share-btn--ig:hover { border-color: #E4405F; color: #fff; background: rgba(228,64,95,.15); }
  .share-btn--copy:hover { border-color: var(--accent-blue); color: var(--accent-blue); background: rgba(68,138,255,.1); }
  .toast-wrap { position: fixed; bottom: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
  .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 10px 18px; font-size: .788rem; color: var(--text-primary); box-shadow: 0 8px 32px rgba(0,0,0,.7); animation: toastIn .3s ease; border-left: 3px solid var(--accent-green); }
  @keyframes toastIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
  .footer { padding: 12px 24px; text-align: center; font-size: 10px; color: var(--text-muted); border-top: 1px solid var(--border); letter-spacing: 1px; }
  @media (max-width: 768px) {
    .header { flex-direction: column; gap: 12px; padding: 12px 16px; }
    .dashboard { padding: 12px 16px; }
    .current-price { font-size: 22px; }
    .chart-container { height: 160px; }
    .cvd-chart-container { height: 220px; }
    .info-row { gap: 8px; }
    .info-card { min-width: 140px; padding: 12px; }
    .watermark { font-size: 28px; }
    .share-bar { flex-direction: column; gap: 10px; align-items: stretch; }
    .share-bar-preview { max-width: 100%; }
    .share-bar-buttons { justify-content: center; flex-wrap: wrap; }
    .share-btn span.label-text { display: none; }
    .share-btn { padding: 8px 10px; }
  }
</style>
</head>
<body>
<div class="header">
  <div class="header-title">거래소별 CVD</div>
  <div class="coin-tabs">
    <button class="coin-tab active" data-coin="BTC">BTC</button>
    <button class="coin-tab" data-coin="ETH">ETH</button>
    <button class="coin-tab" data-coin="SOL">SOL</button>
  </div>
  <div class="status-bar">
    <div class="status-dot" id="statusDot"></div>
    <span class="status-text" id="statusText">연결 중...</span>
  </div>
</div>
<div class="dashboard">
  <div class="chart-card">
    <div class="watermark">Herdvibe.com</div>
    <div class="section-header">
      <span class="section-title" id="priceLabel">BTC/USDT · Binance Reference</span>
      <div class="price-display">
        <span class="current-price" id="currentPrice">--</span>
        <span class="price-change" id="priceChange">--</span>
      </div>
    </div>
    <div class="chart-container"><canvas id="priceChart"></canvas></div>
  </div>
  <div class="controls-row">
    <span style="font-size:10px;color:var(--text-muted);letter-spacing:1px;">집계 간격:</span>
    <button class="timeframe-btn active" data-bucket="5">5s</button>
    <button class="timeframe-btn" data-bucket="15">15s</button>
    <button class="timeframe-btn" data-bucket="30">30s</button>
    <button class="timeframe-btn" data-bucket="60">1m</button>
    <button class="reset-btn" id="resetBtn">CVD 리셋</button>
  </div>
  <div class="chart-card">
    <div class="watermark">Herdvibe.com</div>
    <div class="section-header">
      <span class="section-title">거래소별 CVD (Cumulative Volume Delta)</span>
    </div>
    <div class="cvd-chart-container"><canvas id="cvdChart"></canvas></div>
    <div class="exchange-legend" id="exchangeLegend"></div>
  </div>
  <div class="info-row">
    <div class="info-card"><div class="info-label">합산 CVD</div><div class="info-value" id="totalCvd">$0</div></div>
    <div class="info-card"><div class="info-label">최대 매수 압력</div><div class="info-value positive" id="topBuyer">--</div></div>
    <div class="info-card"><div class="info-label">최대 매도 압력</div><div class="info-value negative" id="topSeller">--</div></div>
    <div class="info-card"><div class="info-label">체결 수 (세션)</div><div class="info-value" id="tradeCount" style="color:var(--accent-blue)">0</div></div>
  </div>
  <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;margin-top:12px;overflow:hidden">
    <div class="share-bar" style="border-top:none">
      <div class="share-bar-preview"><span>거래소별 CVD</span> — herdvibe.com</div>
      <div class="share-bar-buttons">
        <button class="share-btn share-btn--x" onclick="doShare('twitter')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg><span class="label-text">트위터</span></button>
        <button class="share-btn share-btn--kakao" onclick="doShare('kakao')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3C6.477 3 2 6.463 2 10.691c0 2.724 1.8 5.112 4.508 6.458l-1.148 4.265a.5.5 0 0 0 .764.533l4.94-3.26c.304.02.612.03.936.03 5.523 0 10-3.462 10-7.735C22 6.463 17.523 3 12 3z"/></svg><span class="label-text">카카오톡</span></button>
        <button class="share-btn share-btn--tg" onclick="doShare('telegram')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg><span class="label-text">텔레그램</span></button>
        <button class="share-btn share-btn--ig" onclick="doShare('instagram',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg><span class="label-text">인스타그램</span></button>
        <button class="share-btn share-btn--copy" onclick="doShare('link',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg><span class="label-text">링크 복사</span></button>
      </div>
    </div>
  </div>
</div>
<div class="footer">HERDVIBE.COM · Real-time CVD from Exchange WebSocket APIs</div>
<script>
var SHARE_URL='https://herdvibe.com/83';
function ensureKakao(){try{if(typeof Kakao!=='undefined'&&!Kakao.isInitialized())Kakao.init('a43ed7b39fac35458f4f9df925a279b5');return typeof Kakao!=='undefined'&&Kakao.isInitialized();}catch(e){return false;}}
ensureKakao();
function copyToClipboard(t){try{window.parent.postMessage({type:'clipboard',text:t},'*');}catch(e){}try{window.parent.postMessage({type:'copy',text:t},'*');}catch(e){}if(navigator.clipboard&&navigator.clipboard.writeText&&window.isSecureContext){navigator.clipboard.writeText(t).catch(function(){});}else{var ta=document.createElement('textarea');ta.value=t;ta.style.position='fixed';ta.style.left='-9999px';ta.style.top='-9999px';ta.style.opacity='0';document.body.appendChild(ta);ta.focus();ta.select();try{document.execCommand('copy');}catch(e){}document.body.removeChild(ta);}}
function flashCopied(btn){if(!btn)return;var o=btn.innerHTML;btn.style.background='#22c55e';btn.style.color='#fff';btn.style.borderColor='#22c55e';btn.innerHTML='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"><path d="M5 13l4 4L19 7"/></svg><span class="label-text" style="color:#fff">복사됨!</span>';setTimeout(function(){btn.style.background='';btn.style.color='';btn.style.borderColor='';btn.innerHTML=o;},2000);}
function doShare(p,btn){var u=SHARE_URL,t=encodeURIComponent('거래소별 CVD | herdvibe.com'),eu=encodeURIComponent(u);switch(p){case'twitter':window.open('https://twitter.com/intent/tweet?text='+t+'&url='+eu,'_blank');break;case'telegram':window.open('https://t.me/share/url?url='+eu+'&text='+t,'_blank');break;case'kakao':if(!ensureKakao()){copyToClipboard(u);toast('링크 복사완료!');}else try{Kakao.Share.sendDefault({objectType:'feed',content:{title:'거래소별 CVD',description:'멀티 거래소 실시간 CVD 대시보드',imageUrl:'https://raw.githubusercontent.com/kittycapital/kittycapital.github.io/main/assets/herdvibe-og.png',link:{mobileWebUrl:u,webUrl:u}},buttons:[{title:'대시보드 보기',link:{mobileWebUrl:u,webUrl:u}}]});}catch(e){copyToClipboard(u);toast('링크 복사완료!');}break;case'instagram':copyToClipboard(u);flashCopied(btn);toast('링크 복사완료! 인스타그램에 붙여넣기 하세요');break;case'link':copyToClipboard(u);flashCopied(btn);toast('링크가 복사되었습니다');break;}}
function toast(m){var c=document.querySelector('.toast-wrap');if(!c){c=document.createElement('div');c.className='toast-wrap';document.body.appendChild(c);}var t=document.createElement('div');t.className='toast';t.textContent=m;c.appendChild(t);setTimeout(function(){t.style.opacity='0';t.style.transform='translateY(12px)';t.style.transition='.3s';setTimeout(function(){t.remove();},300);},3000);}

const EXCHANGES={binance:{name:'Binance',color:'#F0B90B'},bybit:{name:'Bybit',color:'#ff9100'},kraken:{name:'Kraken',color:'#b388ff'},coinbase:{name:'Coinbase',color:'#448aff'}};
const COINS={BTC:{binance:{ws:'btcusdt@trade',rest:'BTCUSDT'},bybit:{ws:'publicTrade.BTCUSDT',rest:'BTCUSDT'},kraken:{ws:'BTC/USD',rest:'XBTUSD'},coinbase:{ws:'BTC-USD',rest:'BTC-USD'}},ETH:{binance:{ws:'ethusdt@trade',rest:'ETHUSDT'},bybit:{ws:'publicTrade.ETHUSDT',rest:'ETHUSDT'},kraken:{ws:'ETH/USD',rest:'ETHUSD'},coinbase:{ws:'ETH-USD',rest:'ETH-USD'}},SOL:{binance:{ws:'solusdt@trade',rest:'SOLUSDT'},bybit:{ws:'publicTrade.SOLUSDT',rest:'SOLUSDT'},kraken:{ws:'SOL/USD',rest:'SOLUSD'},coinbase:{ws:'SOL-USD',rest:'SOL-USD'}}};

let activeCoin='BTC',bucketSeconds=5,sockets={},rawTrades={},cvdData={},hiddenExchanges=new Set(),connectedCount=0,currentPrice=0,startPrice=0,tradeCount=0;
const MAX_RAW=50000,MAX_PTS=600;

function fmt$(v){const a=Math.abs(v),s=v<0?'-':'';if(a>=1e9)return s+'$'+(a/1e9).toFixed(2)+'B';if(a>=1e6)return s+'$'+(a/1e6).toFixed(2)+'M';if(a>=1e3)return s+'$'+(a/1e3).toFixed(1)+'K';return '$'+v.toFixed(0);}
function bucket(ts){return Math.floor(ts/(bucketSeconds*1000))*(bucketSeconds*1000);}

function rebuildHistory(){const keys=Object.keys(EXCHANGES);const cvdH={},priceH=[];keys.forEach(id=>{cvdH[id]=[];const trades=rawTrades[id]||[];let cum=0,lastB=-1;for(const t of trades){cum+=t.isBuy?(t.p*t.q):-(t.p*t.q);const b=bucket(t.t);if(b===lastB&&cvdH[id].length>0){cvdH[id][cvdH[id].length-1].v=cum;}else{cvdH[id].push({t:b,v:cum});lastB=b;}}cvdData[id]=cum;if(cvdH[id].length>MAX_PTS)cvdH[id]=cvdH[id].slice(-MAX_PTS);});const bt=rawTrades.binance||[];let lastPB=-1;for(const t of bt){const b=bucket(t.t);if(b===lastPB&&priceH.length>0){priceH[priceH.length-1].v=t.p;}else{priceH.push({t:b,v:t.p});lastPB=b;}}if(priceH.length>MAX_PTS)priceH.splice(0,priceH.length-MAX_PTS);return{cvdH,priceH};}

const cDef={responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'#16161f',borderColor:'#252535',borderWidth:1,titleFont:{family:"'JetBrains Mono'",size:11},bodyFont:{family:"'JetBrains Mono'",size:11},padding:10,cornerRadius:6}},scales:{x:{type:'linear',display:true,grid:{color:'rgba(255,255,255,0.04)',drawBorder:false},ticks:{font:{family:"'JetBrains Mono'",size:10},color:'#55556a',maxTicksLimit:8,callback:v=>{const d=new Date(v);return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0')+':'+d.getSeconds().toString().padStart(2,'0');}}},y:{grid:{color:'rgba(255,255,255,0.04)',drawBorder:false},ticks:{font:{family:"'JetBrains Mono'",size:10},color:'#55556a'}}}};

let syncing=false;
function syncCharts(sourceChart,targetChart){if(syncing)return;syncing=true;const srcX=sourceChart.scales.x;targetChart.options.scales.x.min=srcX.min;targetChart.options.scales.x.max=srcX.max;targetChart.update('none');syncing=false;}

const priceChart=new Chart(document.getElementById('priceChart').getContext('2d'),{type:'line',data:{datasets:[{data:[],borderColor:'#e8e8ef',borderWidth:1.5,pointRadius:0,fill:{target:'origin',above:'rgba(0,230,118,0.05)',below:'rgba(255,23,68,0.05)'},tension:0.1}]},options:{...cDef,parsing:{xAxisKey:'t',yAxisKey:'v'},scales:{...cDef.scales,y:{...cDef.scales.y,ticks:{...cDef.scales.y.ticks,callback:v=>v>=1000?'$'+v.toLocaleString():'$'+v.toFixed(2)}}},plugins:{...cDef.plugins,zoom:{pan:{enabled:true,mode:'x',onPan:({chart})=>syncCharts(chart,cvdChart)},zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x',onZoom:({chart})=>syncCharts(chart,cvdChart)}}}}});

const cvdChart=new Chart(document.getElementById('cvdChart').getContext('2d'),{type:'line',data:{datasets:[]},options:{...cDef,parsing:{xAxisKey:'t',yAxisKey:'v'},scales:{...cDef.scales,y:{...cDef.scales.y,ticks:{...cDef.scales.y.ticks,callback:v=>fmt$(v)}}},plugins:{...cDef.plugins,zoom:{pan:{enabled:true,mode:'x',onPan:({chart})=>syncCharts(chart,priceChart)},zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x',onZoom:({chart})=>syncCharts(chart,priceChart)}}}}});

function initDatasets(){cvdChart.data.datasets=Object.entries(EXCHANGES).map(([id,ex])=>({label:ex.name,data:[],borderColor:ex.color,borderWidth:1.5,pointRadius:0,tension:0.2,hidden:hiddenExchanges.has(id)}));}
initDatasets();

function renderLegend(){const c=document.getElementById('exchangeLegend');c.innerHTML='';Object.entries(EXCHANGES).forEach(([id,ex])=>{const val=cvdData[id]||0;const el=document.createElement('div');el.className='legend-item'+(hiddenExchanges.has(id)?' hidden':'');el.innerHTML='<div class="legend-dot" style="background:'+ex.color+'"></div><span class="legend-name">'+ex.name+'</span><span class="legend-value '+(val>=0?'positive':'negative')+'">'+fmt$(val)+'</span>';el.addEventListener('click',()=>{hiddenExchanges.has(id)?hiddenExchanges.delete(id):hiddenExchanges.add(id);renderLegend();const idx=Object.keys(EXCHANGES).indexOf(id);if(cvdChart.data.datasets[idx]){cvdChart.data.datasets[idx].hidden=hiddenExchanges.has(id);cvdChart.update('none');}});c.appendChild(el);});}
renderLegend();

function addTrade(exId,price,qty,isBuy,ts){if(!rawTrades[exId])rawTrades[exId]=[];rawTrades[exId].push({t:ts||Date.now(),p:price,q:qty,isBuy});if(rawTrades[exId].length>MAX_RAW)rawTrades[exId]=rawTrades[exId].slice(-MAX_RAW*0.8|0);const delta=isBuy?price*qty:-(price*qty);if(!cvdData[exId])cvdData[exId]=0;cvdData[exId]+=delta;if(exId==='binance'){currentPrice=price;if(!startPrice)startPrice=price;}tradeCount++;}

function connectAll(){disconnectAll();connectedCount=0;Object.keys(EXCHANGES).forEach(id=>{cvdData[id]=0;rawTrades[id]=[];});currentPrice=0;startPrice=0;tradeCount=0;connectBinance();connectBybit();connectKraken();connectCoinbase();}
function disconnectAll(){Object.values(sockets).forEach(ws=>{try{ws.close();}catch(e){}});sockets={};}
function updateStatus(){const dot=document.getElementById('statusDot'),txt=document.getElementById('statusText');const total=Object.keys(EXCHANGES).length;if(connectedCount>0){dot.className='status-dot connected';txt.textContent=connectedCount+'/'+total+' 거래소 연결됨';}else{dot.className='status-dot';txt.textContent='연결 중...';}}

function connectBinance(){const ws=new WebSocket('wss://stream.binance.com:9443/ws/'+COINS[activeCoin].binance.ws);sockets.binance=ws;ws.onopen=()=>{connectedCount++;updateStatus();};ws.onclose=()=>{connectedCount=Math.max(0,connectedCount-1);updateStatus();};ws.onmessage=(e)=>{const d=JSON.parse(e.data);if(d.e==='trade')addTrade('binance',parseFloat(d.p),parseFloat(d.q),!d.m,d.T);};ws.onerror=()=>{};}
function connectBybit(){const ws=new WebSocket('wss://stream.bybit.com/v5/public/spot');sockets.bybit=ws;ws.onopen=()=>{connectedCount++;updateStatus();ws.send(JSON.stringify({op:'subscribe',args:[COINS[activeCoin].bybit.ws]}));};ws.onclose=()=>{connectedCount=Math.max(0,connectedCount-1);updateStatus();};ws.onmessage=(e)=>{const m=JSON.parse(e.data);if(m.topic&&m.topic.startsWith('publicTrade')&&m.data){m.data.forEach(t=>addTrade('bybit',parseFloat(t.p),parseFloat(t.v),t.S==='Buy',parseInt(t.T)));}};ws.onerror=()=>{};}
function connectKraken(){const ws=new WebSocket('wss://ws.kraken.com/v2');sockets.kraken=ws;ws.onopen=()=>{connectedCount++;updateStatus();ws.send(JSON.stringify({method:'subscribe',params:{channel:'trade',symbol:[COINS[activeCoin].kraken.ws]}}));};ws.onclose=()=>{connectedCount=Math.max(0,connectedCount-1);updateStatus();};ws.onmessage=(e)=>{const m=JSON.parse(e.data);if(m.channel==='trade'&&m.data){m.data.forEach(t=>{addTrade('kraken',parseFloat(t.price),parseFloat(t.qty),t.side==='buy',new Date(t.timestamp).getTime());});}};ws.onerror=()=>{};}
function connectCoinbase(){const ws=new WebSocket('wss://ws-feed.exchange.coinbase.com');sockets.coinbase=ws;ws.onopen=()=>{connectedCount++;updateStatus();ws.send(JSON.stringify({type:'subscribe',product_ids:[COINS[activeCoin].coinbase.ws],channels:['matches']}));};ws.onclose=()=>{connectedCount=Math.max(0,connectedCount-1);updateStatus();};ws.onmessage=(e)=>{const m=JSON.parse(e.data);if(m.type==='match'||m.type==='last_match'){addTrade('coinbase',parseFloat(m.price),parseFloat(m.size),m.side==='sell',new Date(m.time).getTime());}};ws.onerror=()=>{};}

function updateUI(){const{cvdH,priceH}=rebuildHistory();const priceEl=document.getElementById('currentPrice');const changeEl=document.getElementById('priceChange');if(currentPrice>0){priceEl.textContent='$'+currentPrice.toLocaleString(undefined,{minimumFractionDigits:activeCoin==='SOL'?2:1,maximumFractionDigits:activeCoin==='SOL'?2:1});if(startPrice>0){const pct=((currentPrice-startPrice)/startPrice*100).toFixed(2);const diff=currentPrice-startPrice;changeEl.textContent=(diff>=0?'+':'')+' $'+diff.toFixed(1)+' ('+pct+'%)';changeEl.className='price-change '+(diff>=0?'up':'down');}}priceChart.data.datasets[0].data=priceH;priceChart.update('none');Object.keys(EXCHANGES).forEach((id,i)=>{if(cvdChart.data.datasets[i])cvdChart.data.datasets[i].data=cvdH[id]||[];});cvdChart.update('none');renderLegend();const total=Object.values(cvdData).reduce((a,b)=>a+b,0);document.getElementById('totalCvd').textContent=fmt$(total);document.getElementById('totalCvd').className='info-value '+(total>=0?'positive':'negative');let topB={n:'--',v:0},topS={n:'--',v:0};Object.entries(cvdData).forEach(([id,val])=>{if(val>topB.v)topB={n:EXCHANGES[id].name,v:val};if(val<topS.v)topS={n:EXCHANGES[id].name,v:val};});document.getElementById('topBuyer').textContent=topB.n+' '+fmt$(topB.v);document.getElementById('topSeller').textContent=topS.n+' '+fmt$(topS.v);document.getElementById('tradeCount').textContent=tradeCount.toLocaleString();}
setInterval(updateUI,1000);

document.querySelectorAll('.coin-tab').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.coin-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');activeCoin=btn.dataset.coin;document.getElementById('priceLabel').textContent=activeCoin+'/USDT · Binance Reference';connectAll();});});
document.querySelectorAll('.timeframe-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.timeframe-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');bucketSeconds=parseInt(btn.dataset.bucket);});});
document.getElementById('resetBtn').addEventListener('click',()=>{Object.keys(EXCHANGES).forEach(id=>{cvdData[id]=0;rawTrades[id]=[];});startPrice=currentPrice;tradeCount=0;priceChart.resetZoom();cvdChart.resetZoom();});

connectAll();
</script>
</body>
</html>
